<!-- restaurants/templates/restaurants/detail.html -->
{% extends 'accounts/base.html' %}

{% block title %}{{ restaurant.name }}{% endblock %}

{% block extra_css %}
<style>
  .tab-active {
    @apply bg-red-600 text-white;
  }
  .tab-inactive {
    @apply text-gray-700 hover:bg-gray-100;
  }
  .hero-bg {
    background-size: cover;
    background-position: center;
    height: 300px;
    border-radius: 1rem;
  }
  .hero-bg-no-photo {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  .star {
    color: #16a34a; /* green-700 */
  }
  .star-empty {
    color: #d1d5db;
  }
  .star-half {
    color: #16a34a;
  }
</style>
{% endblock %}

{% block content %}

<!-- Hero Section -->
<section class="px-6 py-6">
  <div class="hero-bg {% if not restaurant.photo %}hero-bg-no-photo{% endif %} relative rounded-xl overflow-hidden shadow-lg" {% if restaurant.photo %}style="background-image: url('{{ restaurant.photo.url }}');"{% endif %}>
    <div class="absolute inset-0 bg-black bg-opacity-40"></div>
    <div class="relative px-6 py-8 text-white">
      <h1 class="text-3xl font-bold">{{ restaurant.name }}</h1>
      <div class="flex items-center mt-2 space-x-4">
        <span class="bg-yellow-500 text-black px-2 py-1 rounded text-sm font-bold">
          {{ avg_rating|floatformat:"1" }} ⭐
        </span>
        <span class="text-sm">{{ review_count }} reviews</span>
      </div>
      <p class="mt-1 text-sm">Open 24 hours</p>
      <p class="mt-1 text-sm flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        {{ restaurant.address }}
      </p>
    </div>
  </div>
</section>

<!-- Location Section -->
<section class="px-6 py-8 rounded-lg max-w-5xl mx-auto">
  <h2 class="text-xl md:text-2xl font-bold text-red-700 mb-4">Peek the Location</h2>
  <div class="rounded-lg overflow-hidden shadow-md mb-4">
    <div id="map" class="w-full h-64"></div>
  </div>
  <div class="flex justify-between items-center text-sm text-green-800 font-medium px-2">
    <p>{{ restaurant.address }}</p>
    <a
      href="https://www.google.com/maps/dir/?api=1&destination={{ restaurant.latitude }},{{ restaurant.longitude }}&destination_place_id={{ restaurant.name|urlencode }}"
      target="_blank"
      class="bg-white border border-green-700 text-green-700 px-4 py-1 rounded hover:bg-gray-100 transition"
    >
      Get Direction
    </a>
  </div>
</section>

<!-- Tabs: Menu, Reviews, Photos -->
<section class="mt-6 max-w-5xl mx-auto">
  <div class="flex justify-around border rounded-full shadow-sm overflow-hidden" style="background-color: red">
    <button onclick="showTab('menu')" class="tab-active w-full py-2 text-sm font-medium" id="tab-menu">
      Menu
    </button>
    <button onclick="showTab('reviews')" class="tab-inactive w-full py-2 text-sm font-medium" id="tab-reviews">
      Reviews
    </button>
    <button onclick="showTab('photos')" class="tab-inactive w-full py-2 text-sm font-medium" id="tab-photos">
      Photos
    </button>
  </div>

  <!-- Tab Content -->
  <div class="mt-6 bg-white p-6 rounded-lg shadow">
    <!-- Menu Tab -->
    <div id="content-menu">
      <h3 class="text-lg font-bold mb-4">{{ restaurant.name }}'s Menu</h3>
      <!-- Kategori: Steam -->
      <div class="mb-8">
        <h4 class="text-2xl font-semibold text-left text-red-800">Steam</h4>
        {% for menu in menus %}
            <div class="bg-[#fff8f0] p-4 rounded-xl mt-4 shadow flex justify-between items-center">
              <div>
                <h5 class="text-lg font-medium text-black">{{ menu.name }}</h5>
                <p class="text-gray-600 text-sm mt-1">{{ menu.description }}</p>
              </div>
              <div class="text-right">
                <div class="flex items-center gap-4">
                  <p class="text-red-600 font-semibold">
                    Rp {{ menu.price|floatformat:0 }},00
                  </p>
                  <span
                    class="like-btn cursor-pointer text-2xl text-gray-400 hover:text-red-800"
                    data-menu-id="{{ menu.id }}"
                    onclick="toggleLike(this)"
                  >
                    ♡
                  </span>
                </div>
              </div>
            </div>
        {% endfor %}
      </div>
      <!-- Kategori: Fried, Main Dish, Dessert -->
      <!-- (Sama seperti sebelumnya) -->
    </div>

    <!-- Reviews Tab -->
    <div id="content-reviews" class="hidden">
      <h3 class="text-lg font-bold mb-4">Reviews</h3>

      <!-- Rating Summary -->
      <div class="bg-white rounded-xl shadow p-4 mb-6">
        <div class="flex items-center gap-4">
          <span class="text-4xl font-bold text-green-800">{{ avg_rating|floatformat:"1" }}</span>
          <div class="flex flex-col gap-1">
            {% for i in '12345'|make_list %}
              <div class="flex items-center">
                <div class="flex text-sm text-green-800 mr-2">
                  {% for j in '12345'|make_list %}
                    <span class="star {% if j|add:0 <= forloop.parentloop.counter %}star{% else %}star-empty{% endif %}">
                      {% if j|add:0 <= forloop.parentloop.counter %}★{% else %}☆{% endif %}
                    </span>
                  {% endfor %}
                </div>
                <div class="h-2 bg-green-700 rounded w-[70%]"></div>
              </div>
            {% endfor %}
            <p class="text-sm text-gray-600 mt-1">{{ review_count }} Reviews</p>
          </div>
        </div>
      </div>

      <!-- Write Review Form -->
      {% if user.is_authenticated %}
        <div class="bg-white rounded-xl shadow p-4 mb-6">
          <h4 class="font-bold mb-4">Write a Review</h4>
          <form method="POST" action="{% url 'reviews:write_review' restaurant.id %}" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Rating Stars -->
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2 text-gray-900">Rating</label>
              <div class="flex justify-center gap-1 py-2" id="rating-stars">
                {% for i in '12345'|make_list %}
                  <span class="star-rating cursor-pointer text-3xl text-gray-300 hover:text-yellow-400 transition" 
                        data-rating="{{ forloop.counter }}" onclick="setRating({{ forloop.counter }})">★</span>
                {% endfor %}
              </div>
              <input type="hidden" name="rating" id="rating-input" required>
            </div>
            
            <!-- Comment -->
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2 text-gray-900">Comment</label>
              <textarea name="comment" rows="4" 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-gray-900"
                        placeholder="Share your experience..." required></textarea>
            </div>

            <!-- Photo Upload -->
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2 text-gray-900">Photo (Optional)</label>
              <input type="file" name="photo" accept="image/*" 
                     class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-gray-900">
              <p class="text-xs text-gray-500 mt-1">Upload a photo of your dining experience (JPG, PNG, max 5MB)</p>
            </div>
            
            <button type="submit" 
                    class="w-full bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition font-medium">
              Submit Review
            </button>
          </form>
        </div>
      {% else %}
        <div class="bg-gray-50 rounded-xl p-4 mb-6 text-center">
          <p class="text-gray-600 mb-2">Want to write a review?</p>
          <a href="{% url 'accounts:login' %}" 
             class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition inline-block">
            Login to Review
          </a>
        </div>
      {% endif %}

      <!-- Reviews List -->
      {% for review in reviews %}
        <div class="bg-[#fff8f0] rounded-xl shadow p-4 mb-4">
          <div class="flex items-center gap-3">
            {% if review.user.profile and review.user.profile.photo %}
              <img src="{{ review.user.profile.photo.url }}" alt="{{ review.user.username }}" 
                   class="w-10 h-10 rounded-full object-cover">
            {% else %}
              <div class="w-10 h-10 rounded-full bg-gradient-to-br from-amber-100 to-orange-200 flex items-center justify-center text-sm font-bold text-gray-700">
                {{ review.user.username|slice:":1" }}
              </div>
            {% endif %}
            <div>
              <h4 class="font-semibold" style="color: black;">{{ review.user.username }}</h4>
              <div class="flex items-center text-sm mt-1">
                {% for i in '12345'|make_list %}
                  <span class="star {% if forloop.counter <= review.rating %}star{% else %}star-empty{% endif %}">
                    {% if forloop.counter <= review.rating %}★{% else %}☆{% endif %}
                  </span>
                {% endfor %}
              </div>
            </div>
            <span class="ml-auto text-sm text-red-600">
              {{ review.created_at|timesince }} ago
            </span>
          </div>
          <p class="mt-2 text-gray-800">{{ review.comment }}</p>

          <!-- Review Photo -->
          {% if review.photo %}
            <div class="mt-3">
              <img src="{{ review.photo.url }}" alt="Review photo" 
                   class="w-full max-w-md h-48 object-cover rounded-lg shadow-sm">
            </div>
          {% endif %}

          <!-- Replies -->
          {% for reply in review.replies.all %}
            <div class="mt-3 ml-8 bg-gray-50 rounded-lg p-3 border-l-4 border-blue-500">
              <div class="flex items-center gap-2">
                {% if reply.user.profile and reply.user.profile.photo %}
                  <img src="{{ reply.user.profile.photo.url }}" alt="{{ reply.user.username }}" 
                       class="w-6 h-6 rounded-full object-cover">
                {% else %}
                  <div class="w-6 h-6 rounded-full bg-gradient-to-br from-amber-100 to-orange-200 flex items-center justify-center text-xs text-gray-700 font-bold">
                    {{ reply.user.username|slice:":1" }}
                  </div>
                {% endif %}
                <span class="font-semibold text-sm text-blue-700">{{ reply.user.username }}</span>
                <span class="text-xs text-gray-500">{{ reply.created_at|timesince }} ago</span>
              </div>
              <p class="mt-1 text-sm text-gray-700">{{ reply.reply_text }}</p>
            </div>
          {% endfor %}

          <!-- Reply Form -->
          {% if user.is_authenticated %}
            <div class="mt-3 ml-8">
              <button onclick="toggleReplyForm({{ review.id }})" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                💬 Reply
              </button>
              
              <form method="POST" action="{% url 'reviews:add_reply' review.id %}" 
                    id="reply-form-{{ review.id }}" class="hidden mt-2 bg-gray-50 rounded-lg p-3">
                {% csrf_token %}
                <textarea 
                  name="reply_text" 
                  placeholder="Write a reply..." 
                  class="w-full p-2 text-sm border border-gray-300 rounded resize-none text-gray-900" 
                  rows="2" required></textarea>
                <div class="flex justify-end mt-2 space-x-2">
                  <button type="button" onclick="toggleReplyForm({{ review.id }})" 
                          class="px-3 py-1 text-sm text-gray-600 hover:text-gray-800">Cancel</button>
                  <button type="submit" 
                          class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Reply</button>
                </div>
              </form>
            </div>
          {% endif %}
        </div>
      {% empty %}
        <p class="text-gray-500">Belum ada ulasan.</p>
      {% endfor %}
    </div>

    <!-- Photos Tab -->
    <div id="content-photos" class="hidden">
      <h3 class="text-lg font-bold mb-4">Foto Restoran & Menu</h3>
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
        <!-- Restaurant Photo -->
        {% if restaurant.photo %}
          <div class="rounded-lg overflow-hidden">
            <img src="{{ restaurant.photo.url }}" alt="Resto Photo" class="w-full h-40 object-cover">
          </div>
        {% endif %}
        
        <!-- Menu Photos -->
        {% for menu in menus %}
          {% if menu.photo %}
            <div class="rounded-lg overflow-hidden">
              <img src="{{ menu.photo.url }}" alt="{{ menu.name }}" class="w-full h-40 object-cover">
            </div>
          {% endif %}
        {% endfor %}
        
        <!-- Review Photos -->
        {% for review in reviews %}
          {% if review.photo %}
            <div class="rounded-lg overflow-hidden relative">
              <img src="{{ review.photo.url }}" alt="Review by {{ review.user.username }}" class="w-full h-40 object-cover">
              <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white p-2">
                <p class="text-xs">By {{ review.user.username }}</p>
              </div>
            </div>
          {% endif %}
        {% endfor %}
        
        {% if not restaurant.photo and not menus and not reviews %}
          <p class="text-gray-500">Belum ada foto.</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>

{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
  // Inisialisasi peta
  const map = L.map('map').setView([{{ restaurant.latitude }}, {{ restaurant.longitude }}], 16);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);
  L.marker([{{ restaurant.latitude }}, {{ restaurant.longitude }}]).addTo(map)
    .bindPopup("<b>{{ restaurant.name|escapejs }}</b><br>{{ restaurant.address|escapejs }}")
    .openPopup();

  // Tab System
  function showTab(tabName) {
    ['menu', 'reviews', 'photos'].forEach(tab => {
      document.getElementById('content-' + tab).classList.add('hidden');
      document.getElementById('tab-' + tab).className = 'tab-inactive w-full py-2 text-sm font-medium';
    });
    document.getElementById('content-' + tabName).classList.remove('hidden');
    document.getElementById('tab-' + tabName).className = 'tab-active w-full py-2 text-sm font-medium';
  }

  // Reply Form Toggle
  function toggleReplyForm(reviewId) {
    const form = document.getElementById('reply-form-' + reviewId);
    if (form.classList.contains('hidden')) {
      form.classList.remove('hidden');
    } else {
      form.classList.add('hidden');
    }
  }

  // Like System
  function toggleLike(element) {
    const liked = element.classList.contains('text-red-800');
    if (liked) {
      element.textContent = '♡';
      element.classList.remove('text-red-800');
      element.classList.add('text-gray-400');
    } else {
      element.textContent = '❤️';
      element.classList.remove('text-gray-400');
      element.classList.add('text-red-800');
    }
  }

  // Rating System
  function setRating(rating) {
    document.getElementById('rating-input').value = rating;
    const stars = document.querySelectorAll('.star-rating');
    stars.forEach((star, index) => {
      if (index < rating) {
        star.classList.remove('text-gray-300');
        star.classList.add('text-yellow-400');
      } else {
        star.classList.remove('text-yellow-400');
        star.classList.add('text-gray-300');
      }
    });
  }

  // Default tab
  showTab('menu');
</script>
{% endblock %}